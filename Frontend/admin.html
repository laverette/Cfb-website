<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Weekly Picks</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <style>
    body {
      background-color: #1E1E1E;
      color: #F5F5F5;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .admin-section {
      background: #2D2D2D;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border: 2px solid #FFD700;
    }
    .admin-section h2 {
      color: #FFD700;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #F5F5F5;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #8D6E63;
      background: #1E1E1E;
      color: #F5F5F5;
    }
    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      margin-right: 10px;
      margin-top: 10px;
    }
    .btn-primary {
      background: #FFD700;
      color: #1E1E1E;
    }
    .btn-primary:hover {
      background: #FFA000;
    }
    .btn-secondary {
      background: #8D6E63;
      color: #F5F5F5;
    }
    .games-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .game-card {
      background: #1E1E1E;
      border: 2px solid #8D6E63;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .game-card:hover {
      border-color: #FFD700;
      transform: translateY(-2px);
    }
    .game-card.selected {
      border-color: #FFD700;
      background: #3E2723;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
    }
    .modal-content {
      background-color: #2D2D2D;
      margin: 5% auto;
      padding: 20px;
      border: 2px solid #FFD700;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .close {
      color: #FFD700;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: #FFA000;
    }
    .search-box {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 6px;
      border: 1px solid #8D6E63;
      background: #1E1E1E;
      color: #F5F5F5;
    }
    .game-item {
      padding: 10px;
      margin: 5px 0;
      background: #1E1E1E;
      border: 1px solid #8D6E63;
      border-radius: 6px;
      cursor: pointer;
    }
    .game-item:hover {
      background: #3E2723;
      border-color: #FFD700;
    }
    .status-message {
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
    }
    .status-success {
      background: #4CAF50;
      color: white;
    }
    .status-error {
      background: #f44336;
      color: white;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #FFD700;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <h1 style="color: #FFD700; text-align: center; margin-bottom: 30px;">üèà Admin Panel</h1>
    
    <!-- Current Week Section -->
    <div class="admin-section">
      <h2>Current Week Settings</h2>
      <div id="currentWeekInfo" class="loading">Loading...</div>
      <div class="form-group">
        <label>Season Year:</label>
        <input type="number" id="seasonYear" value="2025" min="2020" max="2030">
      </div>
      <div class="form-group">
        <label>Week Number:</label>
        <input type="number" id="weekNumber" value="12" min="1" max="15">
      </div>
      <button class="btn btn-primary" onclick="setCurrentWeek()">Set Current Week</button>
      <div id="weekStatus"></div>
    </div>

    <!-- Fetch Week Schedule Section -->
    <div class="admin-section">
      <h2>Fetch Week Schedule</h2>
      <p>Fetch all games for a specific week from the College Football Data API</p>
      <div class="form-group">
        <label>Year:</label>
        <input type="number" id="fetchYear" value="2025" min="2020" max="2030">
      </div>
      <div class="form-group">
        <label>Week:</label>
        <input type="number" id="fetchWeek" value="12" min="1" max="15">
      </div>
      <button class="btn btn-primary" onclick="fetchWeekSchedule()">Fetch Week Schedule</button>
      <div id="fetchStatus"></div>
    </div>

    <!-- Manage Games Section -->
    <div class="admin-section">
      <h2>Manage Games for Current Week</h2>
      <div id="gamesContainer" class="loading">Loading games...</div>
    </div>
  </div>

  <!-- Game Replacement Modal -->
  <div id="gameModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeGameModal()">&times;</span>
      <h2 style="color: #FFD700;">Select Replacement Game</h2>
      <input type="text" id="gameSearch" class="search-box" placeholder="Search games by team name..." onkeyup="filterGames()">
      <div id="availableGames" class="loading">Loading available games...</div>
    </div>
  </div>

  <script>
    // TODO: Update this to your actual API URL
    // Options:
    // - Railway: 'https://yourapp.up.railway.app/api'
    // - Render: 'https://yourapp.onrender.com/api'
    // - Local: 'http://localhost:5000/api'
    const API_BASE = 'https://cfb-website.onrender.com/api'; // UPDATE THIS TO YOUR ACTUAL API URL
    let currentWeekId = null;
    let currentYear = null;
    let currentWeek = null;
    let allAvailableGames = [];
    let selectedGameNumber = null;

    // Check if user is admin
    async function checkAdmin() {
      const authToken = localStorage.getItem('authToken');
      if (!authToken) {
        window.location.href = 'login.html';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/admin/check-admin`, {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          if (response.status === 401 || response.status === 403) {
            alert('You do not have admin access. Redirecting to home...');
            window.location.href = 'index.html';
            return;
          } else if (response.status === 404) {
            console.error('API endpoint not found. Is the API deployed?');
            alert('API endpoint not found. Please check if the API is deployed and running.');
            return;
          }
        }
      } catch (error) {
        console.error('Error checking admin status:', error);
        alert(`Error connecting to API: ${error.message}\n\nPlease verify:\n1. The API is deployed and running\n2. The API URL is correct: ${API_BASE}`);
      }
    }

    // Load current week info
    async function loadCurrentWeek() {
      try {
        const response = await fetch(`${API_BASE}/picks/current-week`);
        if (response.ok) {
          const data = await response.json();
          currentWeekId = data.id;
          currentYear = data.seasonYear;
          currentWeek = data.weekNumber;
          
          document.getElementById('currentWeekInfo').innerHTML = `
            <p><strong>Current Week:</strong> Week ${data.weekNumber}, ${data.seasonYear}</p>
            <p><strong>Week ID:</strong> ${data.id}</p>
          `;
          
          document.getElementById('seasonYear').value = data.seasonYear;
          document.getElementById('weekNumber').value = data.weekNumber;
          document.getElementById('fetchYear').value = data.seasonYear;
          document.getElementById('fetchWeek').value = data.weekNumber;
          
          loadGames();
        } else if (response.status === 404) {
          document.getElementById('currentWeekInfo').innerHTML = `
            <p style="color: #f44336;">API endpoint not found (404)</p>
            <p style="color: #f44336; font-size: 0.9em;">Please check if the API is deployed at: ${API_BASE}</p>
          `;
        } else {
          const errorText = await response.text();
          document.getElementById('currentWeekInfo').innerHTML = `
            <p style="color: #f44336;">No current week set</p>
            <p style="color: #f44336; font-size: 0.9em;">Status: ${response.status}</p>
          `;
        }
      } catch (error) {
        console.error('Error loading current week:', error);
        document.getElementById('currentWeekInfo').innerHTML = `
          <p style="color: #f44336;">Error loading current week</p>
          <p style="color: #f44336; font-size: 0.9em;">${error.message}</p>
          <p style="color: #f44336; font-size: 0.9em;">API URL: ${API_BASE}</p>
        `;
      }
    }

    // Set current week
    async function setCurrentWeek() {
      const authToken = localStorage.getItem('authToken');
      if (!authToken) {
        alert('Please log in first');
        return;
      }

      const year = parseInt(document.getElementById('seasonYear').value);
      const week = parseInt(document.getElementById('weekNumber').value);

      try {
        const response = await fetch(`${API_BASE}/admin/set-current-week`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            weekNumber: week,
            seasonYear: year
          })
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById('weekStatus').innerHTML = `
            <div class="status-message status-success">Current week set successfully!</div>
          `;
          loadCurrentWeek();
        } else if (response.status === 404) {
          document.getElementById('weekStatus').innerHTML = `
            <div class="status-message status-error">
              API endpoint not found (404).<br>
              Please verify the API is deployed and running at: ${API_BASE}
            </div>
          `;
        } else {
          let errorMessage = `Error: ${response.status} ${response.statusText}`;
          try {
            const error = await response.json();
            errorMessage = error.message || errorMessage;
          } catch {
            const errorText = await response.text();
            if (errorText) errorMessage += ` - ${errorText}`;
          }
          document.getElementById('weekStatus').innerHTML = `
            <div class="status-message status-error">${errorMessage}</div>
          `;
        }
      } catch (error) {
        document.getElementById('weekStatus').innerHTML = `
          <div class="status-message status-error">
            Network Error: ${error.message}<br>
            <small>Check if the API is running at: ${API_BASE}</small>
          </div>
        `;
      }
    }

    // Fetch week schedule
    async function fetchWeekSchedule() {
      const authToken = localStorage.getItem('authToken');
      if (!authToken) {
        alert('Please log in first');
        return;
      }

      const year = parseInt(document.getElementById('fetchYear').value);
      const week = parseInt(document.getElementById('fetchWeek').value);

      document.getElementById('fetchStatus').innerHTML = '<div class="loading">Fetching games...</div>';

      try {
        const response = await fetch(`${API_BASE}/admin/fetch-week-schedule`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            year: year,
            week: week
          })
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById('fetchStatus').innerHTML = `
            <div class="status-message status-success">
              Successfully fetched ${data.gamesInserted} games for Week ${week}, ${year}!
            </div>
          `;
          if (year === currentYear && week === currentWeek) {
            loadGames();
          }
        } else {
          const error = await response.json();
          document.getElementById('fetchStatus').innerHTML = `
            <div class="status-message status-error">Error: ${error.message}</div>
          `;
        }
      } catch (error) {
        document.getElementById('fetchStatus').innerHTML = `
          <div class="status-message status-error">Error: ${error.message}</div>
        `;
      }
    }

    // Load games for current week
    async function loadGames() {
      if (!currentWeekId) {
        document.getElementById('gamesContainer').innerHTML = '<p>No current week set</p>';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/picks/games/week/${currentWeekId}`);
        if (response.ok) {
          const data = await response.json();
          const games = data.games || [];
          
          if (games.length === 0) {
            document.getElementById('gamesContainer').innerHTML = '<p>No games found for this week. Fetch the schedule first.</p>';
            return;
          }

          let html = '<div class="games-list">';
          games.forEach(game => {
            const bettingLine = game.bettingLine ? (game.bettingLine > 0 ? `+${game.bettingLine}` : game.bettingLine) : '-';
            html += `
              <div class="game-card" onclick="openGameModal(${game.gameNumber})">
                <strong>Game ${game.gameNumber}</strong><br>
                ${game.awayTeamName} at ${game.homeTeamName}<br>
                <small>Line: ${bettingLine}</small>
              </div>
            `;
          });
          html += '</div>';
          document.getElementById('gamesContainer').innerHTML = html;
        } else {
          document.getElementById('gamesContainer').innerHTML = '<p style="color: #f44336;">Error loading games</p>';
        }
      } catch (error) {
        console.error('Error loading games:', error);
        document.getElementById('gamesContainer').innerHTML = '<p style="color: #f44336;">Error loading games</p>';
      }
    }

    // Open game replacement modal
    async function openGameModal(gameNumber) {
      selectedGameNumber = gameNumber;
      document.getElementById('gameModal').style.display = 'block';
      document.getElementById('availableGames').innerHTML = '<div class="loading">Loading available games...</div>';

      const authToken = localStorage.getItem('authToken');
      if (!authToken) {
        alert('Please log in first');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/admin/games/${currentYear}/${currentWeek}`, {
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          allAvailableGames = data.games || [];
          displayAvailableGames(allAvailableGames);
        } else {
          document.getElementById('availableGames').innerHTML = '<p style="color: #f44336;">Error loading games</p>';
        }
      } catch (error) {
        console.error('Error loading available games:', error);
        document.getElementById('availableGames').innerHTML = '<p style="color: #f44336;">Error loading games</p>';
      }
    }

    // Display available games
    function displayAvailableGames(games) {
      if (games.length === 0) {
        document.getElementById('availableGames').innerHTML = '<p>No games available for this week</p>';
        return;
      }

      let html = '';
      games.forEach((game, index) => {
        const bettingLine = game.spread ? (game.spread > 0 ? `+${game.spread}` : game.spread) : '-';
        html += `
          <div class="game-item" onclick="selectGame(${index})">
            <strong>${game.awayTeam || 'TBD'} at ${game.homeTeam || 'TBD'}</strong><br>
            <small>Line: ${bettingLine} | ${game.conferenceGame ? 'Conference' : 'Non-Conference'}</small>
          </div>
        `;
      });
      document.getElementById('availableGames').innerHTML = html;
    }

    // Filter games
    function filterGames() {
      const searchTerm = document.getElementById('gameSearch').value.toLowerCase();
      const filtered = allAvailableGames.filter(game => {
        const homeTeam = (game.homeTeam || '').toLowerCase();
        const awayTeam = (game.awayTeam || '').toLowerCase();
        return homeTeam.includes(searchTerm) || awayTeam.includes(searchTerm);
      });
      displayAvailableGames(filtered);
    }

    // Select game to replace
    async function selectGame(index) {
      const authToken = localStorage.getItem('authToken');
      if (!authToken) {
        alert('Please log in first');
        return;
      }

      const game = allAvailableGames[index];
      if (!game || !game.homeId || !game.awayId) {
        alert('Invalid game selected');
        return;
      }

      const homeLogoUrl = `https://a.espncdn.com/i/teamlogos/ncaa/500/${game.homeId}.png`;
      const awayLogoUrl = `https://a.espncdn.com/i/teamlogos/ncaa/500/${game.awayId}.png`;

      try {
        const response = await fetch(`${API_BASE}/admin/games/${currentWeekId}/game/${selectedGameNumber}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            homeTeamEspnId: game.homeId,
            awayTeamEspnId: game.awayId,
            homeTeamName: game.homeTeam || '',
            awayTeamName: game.awayTeam || '',
            homeTeamLogoUrl: homeLogoUrl,
            awayTeamLogoUrl: awayLogoUrl,
            gameDate: game.startDate ? new Date(game.startDate) : null,
            bettingLine: game.spread || null
          })
        });

        if (response.ok) {
          alert('Game updated successfully!');
          closeGameModal();
          loadGames();
        } else {
          const error = await response.json();
          alert(`Error: ${error.message}`);
        }
      } catch (error) {
        console.error('Error updating game:', error);
        alert('Error updating game');
      }
    }

    // Close modal
    function closeGameModal() {
      document.getElementById('gameModal').style.display = 'none';
      document.getElementById('gameSearch').value = '';
      selectedGameNumber = null;
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('gameModal');
      if (event.target == modal) {
        closeGameModal();
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      checkAdmin();
      loadCurrentWeek();
    });
  </script>
</body>
</html>

